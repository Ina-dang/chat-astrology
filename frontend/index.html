<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ìš´ì„¸ë³´ëŠ” ìœ ìš°ë¦¬</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>
  <body>
    <div class="intro-container">
      <h1>ì‹œë°”ìœ ìš°ë¦¬ê°€ ìš´ì„¸ë¥¼ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.</h1>
      <img src="/doge.webp" alt="doge" />
      <div>
        <label for="date" id="dateLabel"> íƒœì–´ë‚œ ë‚ ì§œ </label>
        <input id="date" type="date" placeholder="íƒœì–´ë‚œ ë‚ ì§œ" />
      </div>
      <div>
        <label for="time" id="timeLabel"> íƒœì–´ë‚œ ì‹œê°„ </label>
        <input id="time" type="time" placeholder="íƒœì–´ë‚œ ì‹œê°„" />
      </div>
      <button onclick="handleStart()">ì˜¤ëŠ˜ì˜ ìš´ì„¸ë³´ê¸°</button>
    </div>
    <div class="chat-container">
      <div class="chat-header">ìš´ì„¸ë³´ëŠ” ìœ ìš°ë¦¬</div>
      <div class="chat-messages" id="chatMessages">
        <div class="loading" id="loading">
          <i class="fa-solid fa-spinner fa-spin"></i>
        </div>
      </div>
      <div class="chat-input">
        <input
          type="text"
          id="messageInput"
          placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
          onkeypress="handleEnter(event)"
        />
        <button onclick="sendMessage()">ë³´ë‚´ê¸°</button>
      </div>
    </div>
    <div class="kakao-add">
      <a href="https://toss.me/inadang">
        ìš´ì„¸ê°€ ë§ˆìŒì— ë“¤ì—ˆë‹¤ë©´? ë³µì±„ë³´ë‚´ê¸°ğŸ€
      </a>
      <ins
        class="kakao_ad_area"
        style="display: none"
        data-ad-unit="DAN-XtUlfyiwPrPohP8p"
        data-ad-width="320"
        data-ad-height="50"
      ></ins>
      <script
        type="text/javascript"
        src="//t1.daumcdn.net/kas/static/ba.min.js"
        async
      ></script>
    </div>
    <script src="env.js" />
    <script>
      let userMessages = [];
      let assistantMessages = [];
      let myBirthTime = '';

      function handleEnter() {
        if (event.keyCode == 13) {
          sendMessage();
          document.getElementById('messageInput').focus();
        }
      }

      function handleStart() {
        const date = document.getElementById('date').value;
        const time = document.getElementById('time').value;
        if (!date) {
          alert('ìƒë…„ì›”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
          return;
        }
        myBirthTime = date + ' ' + time;
        console.log('myBirthTime', myBirthTime);
        document.querySelector('.intro-container').style.display = 'none';
        document.querySelector('.chat-container').style.display = 'block';
        document.querySelector('.kakao-add a ').style.display = 'block';
      }

      console.log('userMessages', userMessages);
      console.log('assistantMessages', assistantMessages);

      const chatMessages = document.getElementById('chatMessages');

      const appendMessage = (message, sender) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${sender}`;
        messageDiv.textContent = message;
        if (sender === 'assistant') {
          messageDiv.classList.add('assistant');
          message !== 'ìš´ì„¸ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...' &&
            assistantMessages.push(message);
        } else {
          userMessages.push(message);
        }
        chatMessages.appendChild(messageDiv);
        // Scroll to the bottom of chat messages
        chatMessages.scrollTop = chatMessages.scrollHeight;
      };

      const sendGreeting = () => {
        const greeting = 'ì•ˆë…•í•˜ì„¸ìš”~ ì˜¤ëŠ˜ì˜ ìš´ì„¸ë¥¼ í™•ì¸í•˜ì‹œê² ì–´ìš”?';
        appendMessage(greeting, 'assistant');
      };

      const sendMessage = () => {
        openLoading();
        const message = document.getElementById('messageInput').value.trim();
        if (message === '') {
          alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        appendMessage(message, 'user');
        document.getElementById('messageInput').value = ''; // Clear input field
        postFortune({ userMessages, assistantMessages, myBirthTime }); // Fetch fortune after sending message
      };

      const postFortune = async (data) => {
        try {
          if (data.userMessages[0].includes('ìš´ì„¸')) {
            appendMessage('ìš´ì„¸ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...', 'assistant');
            const response = await fetch(`${lamdaUrl}/askQuestion`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(data),
            });
            const result = await response.json();
            appendMessage(result.assistant, 'assistant');
          } else {
            // ìš´ì„¸ê°€ ì•„ë‹Œ ì¼ë°˜ ë©”ì‹œì§€ì¸ ê²½ìš°
            // fetch ìš”ì²­ì„ ë³´ë‚¼ í•„ìš” ì—†ìœ¼ë¯€ë¡œ ë³„ë„ì˜ ë¡œë”© ì²˜ë¦¬ ì—†ì´ ë°”ë¡œ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            const response = await fetch(`${lamdaUrl}/askQuestion`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(data),
            });
            const result = await response.json();
            appendMessage(result.assistant, 'assistant');
          }
          closeLoading();
        } catch (error) {
          console.error(error);
          appendMessage(
            'ìš´ì„¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
            'assistant'
          );
          closeLoading();
        }
      };

      const displayFortune = (fortune) => {
        const messages = fortune.split('\n\n');
        messages.forEach((message, index) => {
          setTimeout(
            () => appendMessage(message.trim(), 'assistant'),
            index * 1000
          );
        });
      };

      function openLoading() {
        const loadingDiv = document.querySelector('.loading');
        loadingDiv.style.display = 'flex'; // ë¡œë”© ì°½ í‘œì‹œ
      }
      function closeLoading() {
        const loadingDiv = document.querySelector('.loading');
        loadingDiv.style.display = 'none'; // ë¡œë”© ì°½ ì œê±°
      }

      // Call the greeting function when the page loads
      sendGreeting();
    </script>
  </body>
</html>
